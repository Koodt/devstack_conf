# Setup for this config: vrtualbox, mac m4
# 1. Set devstack branch to stable/2025.2
# 2. Copy this file to the devstack directory
# 3. Download the amphora image from the following URL:
#    wget https://tarballs.opendev.org/openstack/octavia/test-images/test-only-amphora-x64-haproxy-ubuntu-jammy.qcow2
#    save it in the devstack directory as amphora-x64-haproxy.qcow2 and set the
#    OCTAVIA_AMP_IMAGE_FILE variable to the path of the image
# 4. Edit the local.conf file to set the PASSWORD and HOST_IP variables
# 5. Set the LIBVIRT_CPU_MODE variable and libvirt section cpu_mode to
#    host-passthrough for the vagrant box and none for the virtualbox machine
# 6. Run the following command to start the devstack: ./stack.sh
# 7. Source openrc admin admin

[[local|localrc]]
# ----------------------------------------------------------
# Global VARs
# ----------------------------------------------------------
PASSWORD=ENTER_YOUR_VERY_SECURE_PASSWORD_HERE

HOST_IP=ENTER_IP_OF_DEVSTACK_HOST
SERVICE_HOST=$HOST_IP

ADMIN_PASSWORD=$PASSWORD
DATABASE_PASSWORD=$PASSWORD
RABBIT_PASSWORD=$PASSWORD
SERVICE_PASSWORD=$PASSWORD
MYSQL_PASSWORD=$PASSWORD

LOGFILE=$DEST/logs/stack.sh.log

# ----------------------------------------------------------
# Keystone, Glance, Nova
# ----------------------------------------------------------
enable_service key
enable_service g-api g-reg

enable_service n-api n-crt n-cpu n-cond n-sch
# For the vagrant box, we need to set the CPU mode to host-passthrough
#LIBVIRT_CPU_MODE=host-passthrough

# For the virtualbox machine, we need to set the CPU mode to none
LIBVIRT_CPU_MODE=none

LIBVIRT_CPU_MODEL=""

# ----------------------------------------------------------
# Disable services
# ----------------------------------------------------------
disable_service horizon
disable_service ovn
disable_service ovn-controller
disable_service ovn-northd
disable_service q-ovn-metadata-agent
disable_service neutron-ovn-metadata-agent
disable_service tempest
disable_service swift

# ----------------------------------------------------------
# Enable Cinder
# ----------------------------------------------------------
enable_plugin cinder https://opendev.org/openstack/cinder stable/2025.2
enable_service cinder
enable_service c-api
enable_service c-vol
enable_service c-sch
enable_service c-bak

VOLUME_GROUP_NAME=stack-volumes
VOLUME_NAME_PREFIX=volume-
VOLUME_BACKING_FILE_SIZE=24G

CINDER_QUOTA_VOLUMES=100
CINDER_QUOTA_BACKUPS=100
CINDER_QUOTA_SNAPSHOTS=100

CINDER_TARGET_HELPER=lioadm
CINDER_TARGET_PROTOCOL=iscsi
CINDER_TARGET_PREFIX=iqn.2010-10.org.openstack:
CINDER_TARGET_PORT=3260
CINDER_ISCSI_HELPER=lioadm

# ----------------------------------------------------------
# Enable Neutron OVS
# ----------------------------------------------------------
enable_plugin neutron https://opendev.org/openstack/neutron stable/2025.2
enable_service neutron
enable_service q-svc
enable_service q-agt
enable_service q-dhcp
enable_service q-meta
enable_service q-l3
enable_service q-qos

# ----------------------------------------------------------
# Enable Octavia
# ----------------------------------------------------------
enable_plugin octavia https://opendev.org/openstack/octavia stable/2025.2
enable_service octavia
enable_service o-api
enable_service o-hk
enable_service o-hm
enable_service o-cw

# Download the amphora image from the following URL:
# wget https://tarballs.opendev.org/openstack/octavia/test-images/test-only-amphora-x64-haproxy-ubuntu-jammy.qcow2
# and save it in the devstack directory as amphora-x64-haproxy.qcow2
OCTAVIA_AMP_IMAGE_FILE=/opt/stack/devstack/amphora-x64-haproxy.qcow2
OCTAVIA_AMP_IMAGE_SIZE=3
USE_PYTHON3=True

# ----------------------------------------------------------
# Neutron VARs
# ----------------------------------------------------------
Q_AGENT=openvswitch
Q_USE_SECGROUP=True
FLOATING_RANGE=172.24.4.0/24
PUBLIC_NETWORK_GATEWAY=172.24.4.1
Q_FLOATING_ALLOCATION_POOL=start=172.24.4.10,end=172.24.4.200
Q_L3_ENABLED=True

# ----------------------------------------------------------
# Workers
# ----------------------------------------------------------
API_WORKERS=1
RPC_WORKERS=1

# ----------------------------------------------------------
# Post-config: Neutron ML2 + OVS + vxlan/gre
# ----------------------------------------------------------
[[post-config|$NEUTRON_CONF]]
[DEFAULT]
debug=True
verbose=True

[[post-config|/$Q_PLUGIN_CONF_FILE]]
[ml2]
type_drivers=flat,gre,vlan,vxlan
tenant_network_types=vxlan
mechanism_drivers=openvswitch,l2population

[agent]
tunnel_types=vxlan,gre

# ----------------------------------------------------------
# Post-config: Nova passthrough
# ----------------------------------------------------------
[[post-config|$NOVA_CPU_CONF]]
[libvirt]
# For the vagrant box, we need to set the CPU mode to host-passthrough
#cpu_mode=host-passthrough

# For the virtualbox machine, we need to set the CPU mode to none
cpu_mode=none
cpu_model=""